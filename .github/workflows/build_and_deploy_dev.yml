name: Build & deploy develop to umap-dev.hotosm.org

on:
  push:
    branches:
      - develop
    paths:
      - "app/**"
      - "compose.dev.yml"
      - ".github/workflows/*"
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push hotosm-umap
        uses: docker/build-push-action@v5
        with:
          context: ./app
          file: ./app/Dockerfile
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/hotosm-umap:develop

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: develop
    steps:
      - uses: actions/checkout@v4
      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Add host to known_hosts
        run: ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy
        env:
          GH_ACTOR: ${{ github.actor }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          UMAP_OSM_KEY: ${{ secrets.UMAP_OSM_KEY }}
          UMAP_OSM_SECRET: ${{ secrets.UMAP_OSM_SECRET }}
          UMAP_DB_PASSWORD: ${{ secrets.UMAP_DB_PASSWORD }}

          S3_ENDPOINT_URL: ${{ vars.S3_ENDPOINT_URL }}
          S3_BUCKET_NAME: ${{ vars.S3_BUCKET_NAME }}
          ENABLE_S3_STORAGE: ${{ vars.ENABLE_S3_STORAGE }}
          UMAP_SITE_URL: ${{ vars.UMAP_SITE_URL }}
          SITE_ADMIN_EMAIL: ${{ vars.SITE_ADMIN_EMAIL }}
          SITE_DOMAIN: ${{ vars.SITE_DOMAIN }}
          ALLOWED_HOSTS: ${{ vars.ALLOWED_HOSTS }}
          CSRF_TRUSTED_ORIGINS: ${{ vars.CSRF_TRUSTED_ORIGINS }}
          APP_REPLICAS: ${{ vars.APP_REPLICAS }}
          APP_MEM: ${{ vars.APP_MEM }}
          APP_MEM_RES: ${{ vars.APP_MEM_RES }}
          REALTIME_ENABLED: ${{ vars.REALTIME_ENABLED }}
          UMAP_SOCIAL_AUTH_REDIRECT_IS_HTTPS: ${{ vars.UMAP_SOCIAL_AUTH_REDIRECT_IS_HTTPS }}
          # Hanko SSO
          AUTH_PROVIDER: ${{ vars.AUTH_PROVIDER }}
          HANKO_API_URL: ${{ vars.HANKO_API_URL }}
          JWT_ISSUER: ${{ vars.JWT_ISSUER }}
          LOGIN_URL: ${{ vars.LOGIN_URL }}
          COOKIE_SECRET: ${{ secrets.COOKIE_SECRET }}
          COOKIE_DOMAIN: ${{ vars.COOKIE_DOMAIN }}
          COOKIE_SECURE: ${{ vars.COOKIE_SECURE }}
          ADMIN_EMAILS: ${{ vars.ADMIN_EMAILS }}
        run: |
          ssh $EC2_USER@$EC2_HOST << ENDSSH
            set -e
            export UMAP_OSM_KEY="$UMAP_OSM_KEY"
            export UMAP_OSM_SECRET="$UMAP_OSM_SECRET"
            export UMAP_DB_PASSWORD="$UMAP_DB_PASSWORD"
            export S3_ENDPOINT_URL="$S3_ENDPOINT_URL"
            export S3_BUCKET_NAME="$S3_BUCKET_NAME"
            export ENABLE_S3_STORAGE="$ENABLE_S3_STORAGE"
            export UMAP_SITE_URL="$UMAP_SITE_URL"
            export SITE_ADMIN_EMAIL="$SITE_ADMIN_EMAIL"
            export SITE_DOMAIN="$SITE_DOMAIN"
            export ALLOWED_HOSTS="$ALLOWED_HOSTS"
            export CSRF_TRUSTED_ORIGINS="$CSRF_TRUSTED_ORIGINS"
            export APP_REPLICAS="$APP_REPLICAS"
            export APP_MEM="$APP_MEM"
            export APP_MEM_RES="$APP_MEM_RES"
            export REALTIME_ENABLED="$REALTIME_ENABLED"
            export UMAP_SOCIAL_AUTH_REDIRECT_IS_HTTPS="$UMAP_SOCIAL_AUTH_REDIRECT_IS_HTTPS"
            # Hanko SSO
            export AUTH_PROVIDER="$AUTH_PROVIDER"
            export HANKO_API_URL="$HANKO_API_URL"
            export JWT_ISSUER="$JWT_ISSUER"
            export LOGIN_URL="$LOGIN_URL"
            export COOKIE_SECRET="$COOKIE_SECRET"
            export COOKIE_DOMAIN="$COOKIE_DOMAIN"
            export COOKIE_SECURE="$COOKIE_SECURE"
            export ADMIN_EMAILS="$ADMIN_EMAILS"
            APP_DIR="/home/$EC2_USER/umap.hotosm.org"
            # Initial setup if it doesn't exist
            if [ ! -d "\$APP_DIR" ]; then
                sudo mkdir -p \$APP_DIR
                sudo chown \$USER:\$USER \$APP_DIR
                git clone -b develop https://github.com/hotosm/umap.git \$APP_DIR
                echo "✅ Cloned repository"
            fi
            cd \$APP_DIR
            # Pull latest changes
            git fetch origin develop
            git reset --hard origin/develop
            echo "✅ Updated to latest develop"
            # Pull and deploy
            sed -i -e 's/umap.hotosm.org/umap-dev.hotosm.org/g' nginx/conf.d/umap.conf
            docker compose -f compose.dev.yml pull
            docker compose -f compose.dev.yml up -d --force-recreate
            # Cleanup
            docker image prune -af
            echo "✅ Deployment complete"
          ENDSSH

